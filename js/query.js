/*global define, _ */

define(['Debug', 'jqueryloader'], function (Debug, jquery) {
    'use strict';

    var debug = new Debug('query'),
        _defaultConfig = {
            feedURL: null,
            fields: [
                'id',
                'title',
                'expirationDate',
                'content',
                'thumbnails'
            ]
        },
        _config = {};

    function _makeRequest (requestURL) {
        var deferred = new jquery.Deferred();
        debug.log('_makeRequest', requestURL);

        if (!_.isURL(requestURL))
        {
            var errorResponse = {
                type: 'error',
                description: "You didn't supply a URL"
            };

            deferred.reject(errorResponse);
        }
        else
        {
            var jqxhr = jquery.get(requestURL)
                .done(function (jsonString) {
                    try {
                        var json = JSON.parse(jsonString);
                        deferred.resolve(json);
                    }
                    catch (error)
                    {
                        deferred.reject(error);
                    }
                })
                .fail(function (error) {
                    debug.log('failed', arguments);
                    deferred.reject(JSON.parse(error));
                })
                .always(function () {
                    debug.log('always logged', arguments);
                });
        }

        return deferred;
    }

    var getFeedDetails = function (feedURL, callback) { //callback is optional since we return a Promise
        var deferred = new jquery.Deferred();
        var errorResponse = {
            type: 'error',
            description: "You didn't supply a URL to getFeedDetails()"
        };

        if (_.isUndefined(feedURL))
        {
            errorResponse.description = "Whatever was passed to getFeedDetails() was undefined";
            return deferred.reject(errorResponse);
        }
        else if (!isFeedURL(feedURL))
        {
            errorResponse.description = "You didn't supply a valid feed URL to getFeedDetails()";
            return deferred.reject(errorResponse);
        }

        feedURL = _.removeQueryParams(feedURL);
        feedURL += '?form=json&range=1-1';

        _makeRequest(feedURL).always(function (response) {
            //with every error response coming from _makeRequest, there's a type property, so we know this is an error
            // if it's defined
            if (_.isUndefined(response.type))
            {
                var shallowified = {};

                _.each(response, function (value, key) {
                    if (!_.isObject(value))
                    {
                        shallowified[key] = value;
                    }
                });

                deferred.resolve(shallowified);
            }
            else
            {
                deferred.reject(response);
            }

            //if a callback was passed in (optional), then we can call it back here with the @@packageName scope
            if (_.isFunction(callback))
            {
                callback.apply(window['@@packageName'], response);
            }
        });

        return deferred;
    };

    var getVideo = function (obj, callback) {
        var video = {},
            deferred = new jquery.Deferred(),
            feedURL = _.removeQueryParams(obj) || _defaultConfig.feedURL,
            errorResponse = {
                type: 'error',
                description: ""
            };

        if (!_.isDefined(obj) || _.isEmpty(obj) || _.isArray(obj) && !feedURL)
        {
            errorResponse.description = "You need to supply SOMETHING to getVideo()";
            deferred.reject(false);
        }

        if (isFeedURL(obj)) //feed url
        {
            feedURL += '?form=json&range=1-1'; //we just want to grab the first video, so let's make the request lighter
        }
//        else if (isReleaseURL(obj)) //release url
//        {
//            var releaseURL = _.removeQueryParams(obj);
//        }
        else if (isGuid(obj)) //true guid
        {
            debug.log("byGuid=" + obj);
            feedURL += "?form=json&range=1-1&byGuid=" + obj;
        }
        else //start making assumptions and trying stuff
        {
//            if (_.isFinite(obj)) //id
//            {
//                jquery.noop();
//            }

            feedURL += "?form=json&range=1-1&byGuid=" + obj; //try guid
//            feedURL += "?form=json&range=1-1&byReleaseId=" + obj; //try release id
//            feedURL += "?form=json&range=1-1&byReleaseGuid=" + obj; //try release guid
//            feedURL += "?form=json&range=1-1&byPid=" + obj; //try pid
        }

        if (isFeedURL(feedURL))
        {
            debug.log("Making request for getVideo()", feedURL);

            _makeRequest(feedURL)
                .done(function (response) {
                    deferred.resolve(response);
                })
                .fail(function (response) {
                    deferred.fail(response);
                })
                .always(function (response) {
                    // if we've been given a callback, we should call it no matter what
                    if (_.isFunction(callback))
                    {
                        callback.apply(response);
                    }
                });
        }
        else
        {
            errorResponse.description = "If you'd like to get a video just from its GUID, please set a default feed to use first using setDefaultFeedURL()";
            deferred.reject(errorResponse);
            if (_.isFunction(callback))
            {
                callback.apply(errorResponse);
            }
        }

        return deferred;
    };

    var isFeedURL = function (url) {
        if (_.isString(url) && _.isURL(url) && url.indexOf('feed.theplatform.com') !== -1)
        {
            return true;
        }

        return false;
    };

    var isGuid = function (guid) {
        var regex = /^\{?[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\}?$/i;

        return regex.test(guid);
    };

    var isReleaseURL = function (url) {
        if (_.isString(url) && _.isURL(url) && url.indexOf('link.theplatform.com') !== -1)
        {
            return true;
        }

        return false;
    };

    var setDefaultFeedURL  = function (feedURL) {
        if (!isFeedURL(feedURL))
        {
            throw new Error("The feed URL you provided to setDefaultFeedURL() is not a valid feed");
        }
        else
        {
            _defaultConfig.feedURL = _.removeQueryParams(feedURL);
        }

        return true;
    };



    function init (config) {
        if (_.isDefined(config))
        {
            _config = _.defaults(config, _defaultConfig); //apply defaults to any null/undefined values
        }
    }

    return {
        getFeedDetails: getFeedDetails,
        getVideo: getVideo,
        isFeedURL: isFeedURL,
        isGuid: isGuid,
        isReleaseURL: isReleaseURL,
        setDefaultFeedURL: setDefaultFeedURL
    };
});